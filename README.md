# 核销收图插件

一个基于 AstrBot 的 OCR 和二维码识别插件，专门用于处理核销业务场景。

## 功能特性

- 🔍 **OCR 文字识别**：自动识别图片中的文字内容，特别针对手机号码提取
- 📱 **手机号提取**：智能识别包含"购号码"关键词的文本并提取11位手机号
- 🔲 **二维码识别**：支持识别和解析二维码内容
- 📸 **批量处理**：一次性处理三张图片，自动分配不同的处理逻辑
- 🧹 **自动清理**：处理完成后自动清理临时文件

## 安装依赖

在使用插件前，请确保安装以下依赖：

```bash
pip install rapidocr-onnxruntime
pip install opencv-python
pip install pyzbar
```

## 使用方法

### 1. 启动核销模式

发送指令：
```
/hx
```

系统会回复：`📝 已进入核销模式，请发送三张图片`

### 2. 发送图片

按顺序发送三张图片：
- **第1张图片**：包含手机号码信息的图片（需包含"购号码"关键词）
- **第2张图片**：包含二维码的图片
- **第3张图片**：包含二维码的图片

### 3. 处理结果

插件会自动处理这三张图片并返回结果：

- 📱 提取的手机号码
- 🔍 第2张图片的二维码内容
- 🔍 第3张图片的二维码内容

## 处理逻辑

### OCR 文字识别（第1张图片）
- 使用 RapidOCR 引擎进行文字识别
- 查找包含"购号码"关键词的文本行
- 使用正则表达式 `1\d{10}` 提取11位手机号码

### 二维码识别（第2、3张图片）
- 使用 OpenCV 进行图像预处理
- 转换为灰度图像并调整大小
- 应用二值化处理提高识别率
- 使用 pyzbar 库解码二维码内容

## 技术实现

### 核心技术栈
- **RapidOCR**：高性能 OCR 文字识别引擎
- **OpenCV**：图像处理和预处理
- **pyzbar**：二维码解码库
- **AstrBot API**：机器人框架接口

### 图像预处理流程
```python
# 灰度转换
gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)

# 尺寸调整（2倍放大）
resized = cv2.resize(gray, None, fx=2, fy=2, interpolation=cv2.INTER_LINEAR)

# 二值化处理
_, thresh = cv2.threshold(resized, 0, 255, cv2.THRESH_BINARY + cv2.THRESH_OTSU)
```

## 错误处理

插件包含完善的错误处理机制：

- ❌ 图片下载失败时的提示
- ❌ 未识别出手机号时的提示  
- ❌ 二维码识别失败时的提示
- ⚠️ 图片处理异常时的错误信息

## 状态管理

插件使用用户状态管理系统：
- 每个用户独立的监听状态
- 支持群聊和私聊场景
- 自动清理处理完成的状态

## 注意事项

1. **图片顺序**：请按照指定顺序发送图片，第1张用于OCR，第2、3张用于二维码识别
2. **图片质量**：确保图片清晰度足够，模糊图片可能影响识别效果
3. **关键词匹配**：第1张图片必须包含"购号码"关键词才能提取手机号
4. **并发处理**：每个用户同时只能有一个核销任务进行

## 插件信息

- **插件名称**：核销收图
- **版本**：v1.0.0
- **作者**：xiaoxu
- **描述**：监听三张图片进行核销

## 开发说明

### 插件结构
```
astrbot_plugin_ocr/
├── AstrBot/data/plugins/
│   ├── main.py          # 插件主要逻辑
│   └── metadata.yaml    # 插件元数据
└── plugin/
    └── README.md        # 本文档
```

### 扩展功能
如需扩展插件功能，可以考虑：
- 支持更多图片格式
- 增加更多OCR识别规则
- 支持批量二维码处理
- 添加识别结果的数据存储

## 许可证

本插件遵循开源许可证，具体请查看项目根目录的 LICENSE 文件。
